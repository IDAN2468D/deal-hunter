generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum DealType {
  FLIGHT
  HOTEL
}

enum SearchStatus {
  PENDING
  COMPLETED
  FAILED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

model Destination {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  country         String
  imageUrl        String
  images          String[]     @default([])
  slug            String       @unique
  popularityScore Int          @default(0)
  lat             Float?
  lng             Float?
  deals           Deal[]
  priceAlerts     PriceAlert[]
  itineraries     Itinerary[]
  reviewSummary   String?      // AI Generated summary of reviews
  reviewCount     Int          @default(0)
  rating          Float        @default(0.0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Deal {
  id                 String       @id @default(auto()) @map("_id") @db.ObjectId
  title              String
  type               DealType     @default(FLIGHT)
  price              Float
  originalPrice      Float
  currency           String       @default("USD")
  startDate          DateTime
  endDate            DateTime
  imageUrl           String
  isFeatured         Boolean      @default(false)
  aiRating           String?      // e.g., "SUPER_HOT", "GOOD", "AVERAGE"
  flightData         Json?        // Structured flight details
  rawAiOutput        Json?        // To store the agent's original reasoning
  watchCount         Int          @default(0)     // Number of users watching
  verificationStatus Boolean      @default(false) // For the Feedback Loop
  destinationId      String?      @db.ObjectId
  destination        Destination? @relation(fields: [destinationId], references: [id])
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  orders             Order[]
  dealVotes          DealVote[]
}

model PriceAlert {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  targetPrice   Int
  userId        String      @db.ObjectId
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  destinationId String      @db.ObjectId
  destination   Destination @relation(fields: [destinationId], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Itinerary {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  plan          Json        // AI generated day-by-day plan
  userId        String      @db.ObjectId
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  destinationId String      @db.ObjectId
  destination   Destination @relation(fields: [destinationId], references: [id])
  squadRooms    SquadRoom[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// NextAuth Models
model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?   @unique
  passwordHash  String?
  role          String    @default("USER")
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  priceAlerts   PriceAlert[]
  itineraries   Itinerary[]
  searchLogs    SearchLog[]
  squadMemberships SquadMember[]
  orders        Order[]
  preferences   UserPreference?
  profile       UserProfile?
  points        Int           @default(0)
  level         Int           @default(1)
  pointHistory  PointTransaction[]
  dealVotes     DealVote[]
  userBadges    UserBadge[]
  isPro         Boolean       @default(false)
}

model UserPreference {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @unique @db.ObjectId
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferredVibes   String[] @default([])
  maxBudget        Float?
  preferredRegions String[] @default([])
  likedDealIds     String[] @default([]) @db.ObjectId
  discardedDealIds String[] @default([]) @db.ObjectId
  updatedAt        DateTime @updatedAt
}

model UserProfile {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   String   @default("neutral") // e.g., 'luxury', 'backpacker', 'family'
  metrics   Json?    // Logs clicks to adjust persona
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  userId    String      @db.ObjectId
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dealId    String      @db.ObjectId
  deal      Deal        @relation(fields: [dealId], references: [id])
  status    OrderStatus @default(PENDING)
  totalAmount Float
  currency  String      @default("USD")
  ecoFootprint  Float?  // kg of CO2 equivalent
  isCarbonOffset Boolean @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model PointTransaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int
  reason    String   // e.g., "BOOKING_BONUS", "DAILY_LOGIN", "FRIEND_REFFERAL"
  createdAt DateTime @default(now())
}

model SearchLog {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  query      String
  userId     String       @db.ObjectId
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  status     SearchStatus @default(PENDING)
  agentModel String?      // e.g., "gemini-2.5-flash"
  imageUrl   String?      // For Visual Search
  failReason String?
  agentTasks AgentTask[]
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

model AgentTask {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  type        String    // FLIGHT, HOTEL, ACTIVITY
  destination String
  budget      Float
  startDate   DateTime
  endDate     DateTime
  requirements String[]
  searchLogId String    @db.ObjectId
  searchLog   SearchLog @relation(fields: [searchLogId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model SquadRoom {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  inviteCode  String        @unique
  members     SquadMember[]
  itineraryId String?       @db.ObjectId
  itinerary   Itinerary?    @relation(fields: [itineraryId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  dealVotes   DealVote[]
}

model SquadMember {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @db.ObjectId
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  roomId    String    @db.ObjectId
  room      SquadRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  role      String    @default("MEMBER") // OWNER, MEMBER
  createdAt DateTime  @default(now())
}

model DealVote {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  dealId      String    @db.ObjectId
  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  roomId      String    @db.ObjectId
  room        SquadRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  vote        VoteType
  createdAt   DateTime  @default(now())

  @@unique([userId, dealId, roomId])
}

model Badge {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  name        String      @unique
  description String
  iconUrl     String      // Emoji or Image URL
  category    String      // e.g., "TIME", "USAGE", "SOCIAL"
  userBadges  UserBadge[]
  createdAt   DateTime    @default(now())
}

model UserBadge {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String   @db.ObjectId
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt  DateTime @default(now())

  @@unique([userId, badgeId]) // Can only earn a specific badge once
}

model DynamicQuest {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  pointCost   Int      // To burn points
  reward      String   // A tangible reward (e.g., "$50 off Flights", "VIP Lounge Access")
  isActive    Boolean  @default(true)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

model SeoPage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  slug        String   @unique
  title       String
  metaDesc    String
  content     String   // Markdown or HTML
  targetDeals String[] @default([]) // Selected deal IDs
  status      String   @default("draft") // "draft" | "published"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
